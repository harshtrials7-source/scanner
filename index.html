<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Order Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Library to generate QR codes -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- Library for camera-based QR code scanning -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .modal {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            max-width: 90%;
            width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            border-radius: 8px;
            color: white;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .toast.show { opacity: 1; }
        .toast.success { background-color: #28a745; }
        .toast.error { background-color: #dc3545; }
        #qr-reader {
            border: 2px dashed #ccc;
            border-radius: 8px;
            overflow: hidden;
        }
        #app-loader {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            flex-direction: column;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Login Screen -->
    <div id="setup-section" class="container mx-auto p-8 flex items-center justify-center min-h-screen">
        <div class="bg-white p-8 rounded-lg shadow-md text-center w-full max-w-md">
            <h1 class="text-3xl font-bold mb-2">Admin Login</h1>
            <p id="setup-message" class="text-gray-500 mb-6">Enter password to access the dashboard.</p>

            <div id="password-section" class="space-y-4">
                <input type="password" id="password-input" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:outline-none text-center text-lg" placeholder="Enter Password">
                <button id="login-btn" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-md hover:bg-indigo-700 transition-colors text-lg">
                    Login
                </button>
            </div>
        </div>
    </div>

    <!-- Data Loading Spinner -->
    <div id="app-loader" class="hidden">
        <svg class="animate-spin -ml-1 mr-3 h-10 w-10 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="mt-4 text-lg text-gray-600">Loading Order Data...</p>
    </div>


    <!-- Main Application Container -->
    <div id="app-container" class="container mx-auto p-4 md:p-8 hidden">
        <header class="text-center mb-8 flex justify-between items-center">
             <div>
                <h1 class="text-2xl md:text-4xl font-bold text-gray-900">Order Dashboard</h1>
                <p id="role-display" class="text-gray-600 mt-1"></p>
             </div>
             <div>
                 <button id="reset-btn" class="bg-red-500 text-white font-bold py-2 px-4 rounded-md hover:bg-red-600 transition-colors">Logout</button>
             </div>
        </header>

        <!-- Super Admin: Orders List Section -->
        <div id="orders-section" class="bg-white p-6 rounded-lg shadow-md mb-8 hidden">
             <div class="flex flex-col md:flex-row justify-between md:items-center mb-4">
                <h2 class="text-2xl font-semibold">Processed Orders</h2>
                <button id="send-all-emails" class="mt-4 md:mt-0 bg-green-600 text-white font-bold py-2 px-4 rounded-md hover:bg-green-700 transition-colors">
                    Send All QR Emails
                </button>
            </div>
            <div id="orders-list" class="space-y-4 max-h-96 overflow-y-auto">
                <!-- Orders will be dynamically inserted here -->
            </div>
        </div>

        <!-- Scanner Section (for both roles) -->
        <div id="scan-section" class="bg-white p-6 rounded-lg shadow-md hidden">
            <h2 class="text-2xl font-semibold mb-4">Scan QR Code</h2>
             <div id="qr-reader" style="width:100%;"></div>
             <p class="text-center text-gray-500 my-2">OR</p>
            <div class="flex flex-col sm:flex-row gap-2">
                <input type="text" id="qr-scan-input" class="flex-grow p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="Enter Order ID manually">
                <button id="scan-button" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-md hover:bg-indigo-700 transition-colors">
                    Verify Order
                </button>
            </div>
        </div>
    </div>

    <!-- Modal for viewing order details -->
    <div id="order-modal" class="modal-backdrop hidden">
        <div class="modal">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-2xl font-semibold">Order Details</h3>
                <button id="close-modal" class="text-2xl font-bold">&times;</button>
            </div>
            <div id="modal-content"></div>
            <div class="mt-6 flex justify-end gap-3">
                <button id="mark-delivered-button" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 transition-colors">
                    Mark as Delivered
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <script>
        // --- CONFIGURATION ---
        // PASTE YOUR GOOGLE SHEET LINK HERE
        const GOOGLE_SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTfs7Nl2r2tn00rXXbk_ZMMuX9mMfLxr_nAIRM9DfHivbhvNmJZIOQvgXKEworzW36hb4YxWj25Ddkh/pub?gid=0&single=true&output=csv";
        // -------------------

        // DOM Elements
        const setupSection = document.getElementById('setup-section');
        const appLoader = document.getElementById('app-loader');
        const appContainer = document.getElementById('app-container');
        const passwordInput = document.getElementById('password-input');
        const loginBtn = document.getElementById('login-btn');
        const roleDisplay = document.getElementById('role-display');
        const resetBtn = document.getElementById('reset-btn');
        const ordersSection = document.getElementById('orders-section');
        const ordersList = document.getElementById('orders-list');
        const sendAllEmailsBtn = document.getElementById('send-all-emails');
        const scanSection = document.getElementById('scan-section');
        const qrScanInput = document.getElementById('qr-scan-input');
        const scanButton = document.getElementById('scan-button');
        const orderModal = document.getElementById('order-modal');
        const closeModal = document.getElementById('close-modal');
        const modalContent = document.getElementById('modal-content');
        const markDeliveredBtn = document.getElementById('mark-delivered-button');
        const toast = document.getElementById('toast');

        // App State
        let ordersData = {};
        let currentUserRole = null;
        let html5QrCode;
        // This object will temporarily track sent/delivered status for the current session
        let sessionStatus = {};

        function handleInitialLoad() {
            currentUserRole = localStorage.getItem('userRole');
            if (currentUserRole) {
                setupUIForRole(currentUserRole);
            } else {
                setupSection.style.display = 'flex';
            }
        }
        
        document.addEventListener('DOMContentLoaded', handleInitialLoad);
        
        async function fetchAndProcessData() {
            if (!GOOGLE_SHEET_CSV_URL || GOOGLE_SHEET_CSV_URL === "YOUR_GOOGLE_SHEET_CSV_LINK_HERE") {
                showToast("Error: Google Sheet link is not configured.", "error");
                logout();
                return false;
            }
            try {
                const response = await fetch(GOOGLE_SHEET_CSV_URL);
                if (!response.ok) {
                    throw new Error(`Network response was not ok: ${response.statusText}`);
                }
                const csvText = await response.text();
                
                const rows = csvText.split(/\r?\n/).map(row => row.split(','));
                const headers = rows[0].map(h => h.trim());
                const json = rows.slice(1).map(row => {
                    let obj = {};
                    headers.forEach((key, i) => obj[key] = row[i] ? row[i].trim() : '');
                    return obj;
                });
                
                processOrderData(json);
                return true;
            } catch (error) {
                console.error("Failed to fetch or process sheet data:", error);
                showToast("Failed to load data from Google Sheet.", "error");
                logout();
                return false;
            }
        }

        function processOrderData(data) {
            let newOrdersData = {};
            data.forEach(row => {
                const orderId = row['Order ID'];
                if (!orderId) return;

                if (!newOrdersData[orderId]) {
                    newOrdersData[orderId] = {
                        id: orderId,
                        name: row['Name'],
                        email: row['Email'],
                        rollNo: row['Roll No'],
                        items: [],
                    };
                }
                newOrdersData[orderId].items.push({
                    name: row['Item Name'],
                    size: row['Size'],
                    color: row['Color'],
                    customName: row['Custom Name']
                });
            });
            ordersData = newOrdersData;
        }

        async function setupUIForRole(role) {
            currentUserRole = role;
            localStorage.setItem('userRole', role);
            
            setupSection.style.display = 'none';
            appLoader.classList.remove('hidden');
            
            const dataLoaded = await fetchAndProcessData();
            
            appLoader.classList.add('hidden');
            if (!dataLoaded) return;
            
            appContainer.classList.remove('hidden');
            roleDisplay.textContent = `Role: ${role.replace('-', ' ')}`;
            scanSection.classList.remove('hidden');
            initializeScanner();

            if (role === 'super-admin') {
                ordersSection.classList.remove('hidden');
                displayOrders();
            }
        }
        
        function initializeScanner() {
            if (html5QrCode && html5QrCode.isScanning) return;
            try {
                html5QrCode = new Html5Qrcode("qr-reader");
                const config = { fps: 10, qrbox: { width: 250, height: 250 } };
                html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess)
                    .catch(err => {
                        console.log("Unable to start camera scanner.", err);
                        document.getElementById('qr-reader').style.display = 'none';
                    });
            } catch (e) {
                console.error("Error initializing scanner:", e);
            }
        }

        const onScanSuccess = (decodedText) => {
            qrScanInput.value = decodedText;
            verifyOrder(decodedText);
        };
        
        function handleLogin() {
            const password = passwordInput.value;
            if (password === 'ADMIN') {
                setupUIForRole('super-admin');
            } else if (password === 'SCANNER') {
                setupUIForRole('scanner-admin');
            } else {
                showToast('Incorrect password.', 'error');
                passwordInput.value = '';
            }
        }
        
        loginBtn.addEventListener('click', handleLogin);
        passwordInput.addEventListener('keypress', (event) => {
            if (event.key === "Enter") {
                event.preventDefault();
                handleLogin();
            }
        });

        function logout() {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().catch(err => console.error("Failed to stop scanner", err));
            }
            localStorage.removeItem('userRole');
            location.reload();
        }
        resetBtn.addEventListener('click', logout);

        scanButton.addEventListener('click', () => verifyOrder(qrScanInput.value.trim()));
        sendAllEmailsBtn.addEventListener('click', handleSendAllEmails);
        closeModal.addEventListener('click', () => orderModal.classList.add('hidden'));
        orderModal.addEventListener('click', (e) => { if (e.target === orderModal) orderModal.classList.add('hidden'); });
        markDeliveredBtn.addEventListener('click', handleMarkAsDelivered);
        
        function displayOrders() {
            ordersList.innerHTML = '';
            if (Object.keys(ordersData).length === 0) {
                 ordersList.innerHTML = '<p class="text-gray-500 text-center">No orders found in the sheet.</p>';
                 return;
            }
            Object.values(ordersData).forEach(order => {
                const status = sessionStatus[order.id]?.status || 'Pending';
                const emailSent = sessionStatus[order.id]?.emailSent || false;

                const orderCard = `
                    <div id="order-${order.id}" class="border rounded-lg p-4 shadow-sm bg-gray-50 flex flex-col md:flex-row justify-between items-start md:items-center">
                        <div>
                            <p class="font-bold text-lg">${order.id} - <span class="font-medium">${order.name}</span></p>
                            <p class="text-sm text-gray-600">${order.email} | ${order.rollNo}</p>
                        </div>
                        <div class="mt-4 md:mt-0 flex gap-2 items-center flex-wrap">
                             <span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full ${status === 'Delivered' ? 'text-green-600 bg-green-200' : 'text-yellow-600 bg-yellow-200'}">${status}</span>
                             <span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full ${emailSent ? 'text-blue-600 bg-blue-200' : 'text-gray-600 bg-gray-200'}">QR ${emailSent ? 'Sent' : 'Unsent'}</span>
                            <button onclick="window.app.sendQrEmail('${order.id}')" class="bg-blue-500 text-white text-sm font-bold py-1 px-3 rounded-md hover:bg-blue-600 transition-colors">Send QR</button>
                        </div>
                    </div>`;
                ordersList.insertAdjacentHTML('beforeend', orderCard);
            });
        }
        
        function sendQrEmail(orderId, silent = false) {
            const order = ordersData[orderId];
            if (sessionStatus[orderId]?.emailSent && !silent) {
                showToast(`Email for ${orderId} has already been sent in this session.`, 'error');
                return;
            }
            
            const qrCodeContainer = document.createElement('div');
            new QRCode(qrCodeContainer, { text: order.id, width: 128, height: 128 });
            
            setTimeout(() => {
                const itemsList = order.items.map(item => `- ${item.name} (Size: ${item.size}, Color: ${item.color})`).join('\n');
                const subject = `Your Order Confirmation & QR Code: ${order.id}`;
                const body = `Dear ${order.name},\n\nThank you for your order! Please present this QR code at collection.\n\nOrder ID: ${order.id}\n\nItems:\n${itemsList}\n\nThank you,\nTeam Merch`.replace(/\n/g, '%0A');

                window.open(`mailto:${order.email}?subject=${subject}&body=${body}`, '_blank');
                
                if (!sessionStatus[orderId]) sessionStatus[orderId] = {};
                sessionStatus[orderId].emailSent = true;
                
                if(!silent) showToast(`Generated email for ${orderId}.`, 'success');
                displayOrders();
            }, 200);
        }
        window.app = { sendQrEmail };

        function handleSendAllEmails() {
            showToast('Preparing all unsent emails...', 'success');
            const allPromises = Object.keys(ordersData).map((orderId, index) => {
                 return new Promise(resolve => {
                    setTimeout(() => {
                        if (!sessionStatus[orderId]?.emailSent) {
                            sendQrEmail(orderId, true);
                        }
                        resolve();
                    }, index * 200);
                 });
            });
            Promise.all(allPromises).then(() => {
                showToast('All unsent emails prepared.', 'success');
            });
        }

        function verifyOrder(orderId) {
            if (!orderId) { showToast('Please enter or scan an Order ID.', 'error'); return; }
            const order = ordersData[orderId];
            if (!order) { showToast(`Order ID "${orderId}" not found.`, 'error'); return; }
            displayOrderInModal(order);
        }

        function displayOrderInModal(order) {
            const status = sessionStatus[order.id]?.status || 'Pending';
            const itemsHtml = '<ul class="list-disc pl-5 space-y-1">' + order.items.map(item => `<li class="text-gray-700">${item.name} - <strong>Size:</strong> ${item.size}, <strong>Color:</strong> ${item.color}</li>`).join('') + '</ul>';
            modalContent.innerHTML = `<p><strong>Order ID:</strong> ${order.id}</p><p><strong>Name:</strong> ${order.name}</p><p><strong>Status:</strong> <span class="font-semibold ${status === 'Delivered' ? 'text-green-600' : 'text-yellow-600'}">${status}</span></p><h4 class="font-semibold mt-4 mb-2 text-lg">Items:</h4>${itemsHtml}`;
            markDeliveredBtn.dataset.orderId = order.id;
            markDeliveredBtn.disabled = status === 'Delivered';
            markDeliveredBtn.textContent = status === 'Delivered' ? 'Already Delivered' : 'Mark as Delivered';
            markDeliveredBtn.className = `font-bold py-2 px-4 rounded-md transition-colors ${status === 'Delivered' ? 'bg-gray-400 cursor-not-allowed' : 'bg-blue-600 text-white hover:bg-blue-700'}`;
            orderModal.classList.remove('hidden');
        }

        function handleMarkAsDelivered() {
            const orderId = markDeliveredBtn.dataset.orderId;
            const order = ordersData[orderId];
            if (sessionStatus[orderId]?.status === 'Delivered') return;

            if (!sessionStatus[orderId]) sessionStatus[orderId] = {};
            sessionStatus[orderId].status = 'Delivered';
            
            sendDeliveryEmail(order);
            showToast(`Order ${orderId} marked as delivered for this session.`, 'success');
            orderModal.classList.add('hidden');
            if(currentUserRole === 'super-admin') displayOrders();
        }

        function sendDeliveryEmail(order) {
             const subject = `Your Order Has Been Delivered: ${order.id}`;
             const body = `Dear ${order.name},\n\nThis is confirmation that your order ${order.id} has been delivered.\n\nThank you!`.replace(/\n/g, '%0A');
             window.open(`mailto:${order.email}?subject=${subject}&body=${body}`, '_blank');
        }

        let toastTimeout;
        function showToast(message, type = 'success') {
            clearTimeout(toastTimeout);
            toast.textContent = message;
            toast.className = `toast show ${type}`;
            toastTimeout = setTimeout(() => { toast.classList.remove('show'); }, 3000);
        }
    </script>
</body>
</html>

